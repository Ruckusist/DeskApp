from typing import Any

from deskapp.deskchat.server import manager as server
from deskapp.deskchat.client import manager as client


NAME = 'Status'


def init(app: Any):
    # No special init needed
    pass


def draw(app: Any, win, h: int, w: int):
    # Header
    win.addstr(1, 2, 'Server controls: [S]tart  s[T]op  [R]estart')

    st = server.get_status()
    host = st.get('host')
    port = st.get('port')
    running = st.get('running')
    clients = st.get('clients')
    err = st.get('error')

    win.addstr(3, 2, f"Server: {'RUNNING' if running else 'STOPPED'} @ {host}:{port}  clients={clients}")
    if err:
        win.addstr(4, 2, f"Last error: {err}")

    cst = client.get_status()
    win.addstr(6, 2, f"Client: {'CONNECTED' if cst.get('connected') else 'DISCONNECTED'}  user={cst.get('username')}  @ {cst.get('host')}:{cst.get('port')}")
    win.addstr(h-2, 2, 'Press keys: S/T/R to control server')


def handle_key(app: Any, key: int):
    ch = chr(key).lower() if 0 <= key < 256 else ''
    if ch == 's':
        ok, err = server.start(host='localhost', port=28080, verbose=False, sink=app.sink, quiet=True)
        app.data['last_action'] = f'start: {"ok" if ok else "fail"}' + (f' ({err})' if err else '')
    elif ch == 't':
        ok, err = server.stop()
        app.data['last_action'] = f'stop: {"ok" if ok else "fail"}' + (f' ({err})' if err else '')
    elif ch == 'r':
        ok, err = server.stop()
        if ok:
            ok, err = server.start(host='localhost', port=28080, verbose=False, sink=app.sink, quiet=True)
        app.data['last_action'] = f'restart: {"ok" if ok else "fail"}' + (f' ({err})' if err else '')
