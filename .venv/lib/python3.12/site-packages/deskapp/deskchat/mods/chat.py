from typing import Any, List, Tuple

from deskapp.deskchat.client import manager as client


NAME = 'Chat'


def init(app: Any):
    app.data.setdefault('chat', [])
    app.data.setdefault('chat_scroll', 0)


def draw(app: Any, win, h: int, w: int):
    logs: List[Tuple[str, str]] = app.data.get('chat', [])
    scroll = app.data.get('chat_scroll', 0)

    # Determine window
    max_lines = max(1, h - 4)
    start = max(0, len(logs) - max_lines - scroll)
    end = max(0, len(logs) - scroll)
    view = logs[start:end]

    y = 1
    for user, text in view:
        if y >= h - 2:
            break
        prefix = f"{user}: "
        line = prefix + text
        if len(line) > w - 4:
            line = line[: w - 7] + '...'
        win.addstr(y, 2, line)
        y += 1

    win.addstr(h - 2, 2, 'Up/Down to scroll')


def handle_key(app: Any, key: int):
    if key == 259:  # KEY_UP
        app.data['chat_scroll'] = min(100000, app.data.get('chat_scroll', 0) + 1)
    elif key == 258:  # KEY_DOWN
        app.data['chat_scroll'] = max(0, app.data.get('chat_scroll', 0) - 1)
    elif key == 10:  # Enter
        user = client.get_username() or 'me'
        client.chat_local(user, '(message sending not implemented)')
